name: "Android Build (GitHub-only: prebuild + Gradle)"

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
      CI: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci || npm i

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–π (—Ñ–∏–∫—Å –∑–∞–≤–∏—Å–∞–Ω–∏–π)
      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true

      # üîß –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫ –¥–ª—è CI, –µ—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–∏—Ö
      - name: Ensure app icons exist
        run: |
          mkdir -p assets
          sudo apt-get update && sudo apt-get install -y imagemagick
          if [ ! -s assets/icon.png ]; then
            convert -size 512x512 xc:"#C9A574" -gravity center -pointsize 180 -fill white -annotate 0 "BAR" assets/icon.png
            echo "‚úÖ Generated assets/icon.png"
          fi
          if [ ! -s assets/adaptive-icon.png ]; then
            convert -size 512x512 xc:"#C9A574" -gravity center -pointsize 180 -fill white -annotate 0 "BAR" assets/adaptive-icon.png
            echo "‚úÖ Generated assets/adaptive-icon.png"
          fi

      # ‚öôÔ∏è Expo Prebuild
      - name: Prebuild (generate android/)
        env:
          CI: 1
        run: npx expo prebuild --platform android

      # üîê –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ keystore –∏–∑ base64
      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/my-release-key.jks
          echo "‚úÖ Keystore decoded"

      # üß© –ù–∞—Å—Ç—Ä–æ–π–∫–∞ signing-–∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è Gradle
      - name: Configure signing (gradle.properties)
        run: |
          echo "MYAPP_UPLOAD_STORE_FILE=$PWD/android/app/my-release-key.jks" >> android/gradle.properties
          echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/gradle.properties
          echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> android/gradle.properties
          echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}" >> android/gradle.properties

      # üß± –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–∞ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
      - name: Verify keystore exists
        run: |
          if [ ! -f android/app/my-release-key.jks ]; then
            echo "‚ùå Keystore file missing!"
            exit 1
          else
            echo "‚úÖ Keystore file verified."
          fi

      # üèóÔ∏è –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–∞
      - name: Build Release (AAB + APK)
        working-directory: android
        run: |
          ./gradlew clean
          ./gradlew bundleRelease --no-daemon --stacktrace
          ./gradlew assembleRelease --no-daemon --stacktrace

      # üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            android/app/build/outputs/**/*.aab
            android/app/build/outputs/**/*.apk
            android/app/build/outputs/mapping/release/mapping.txt
